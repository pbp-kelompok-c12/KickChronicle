{% comment %} highlight/templates/rating_modal.html {% endcomment %}

<style>
  /* Basic modal styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    opacity: 1;
    transition: opacity 0.3s ease-in-out;
  }
  .modal-overlay.hidden {
    display: none;
    opacity: 0;
    pointer-events: none;
  }
  .modal-content {
    background-color: white;
    padding: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
    width: 90%;
    max-width: 500px;
    transform: scale(1);
    transition: transform 0.3s ease-in-out;
  }
  .modal-overlay.hidden .modal-content {
      transform: scale(0.95);
  }
  .star-rating label {
    cursor: pointer;
    padding: 0 0.2rem;
  }
  .star-rating svg {
    width: 2rem;
    height: 2rem;
    color: #d1d5db;
    transition: color 0.2s;
  }
  .star-rating input[type="radio"] {
    display: none;
  }
  .star-rating label:hover svg,
  .star-rating label:hover ~ label svg,
  .star-rating input[type="radio"]:checked ~ label svg {
    color: #f59e0b;
  }

  /* === Toast Styles === */
  .toast-stack {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    z-index: 60;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .toast {
    min-width: 240px;
    max-width: 360px;
    padding: 0.6rem 0.9rem;
    border-radius: 0.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    color: #0b1727;
    background: #e6f7ed;
    border: 1px solid #86efac;
    font-weight: 600;
    font-size: 0.9rem;
    opacity: 0;
    transform: translateY(8px);
    animation: toast-in 0.18s ease-out forwards;
  }
  .toast.error {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #7f1d1d;
  }
  @keyframes toast-in {
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes toast-out {
    to { opacity: 0; transform: translateY(8px); }
  }
</style>

<div id="ratingModal" class="modal-overlay hidden">
  <div class="modal-content relative">
    <button id="closeModalButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round"
        stroke-linejoin="round" stroke-width="2"
        d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>

    <h2 class="text-xl font-semibold mb-4 text-gray-800">Rate this Highlight</h2>

    <div class="star-rating flex flex-row-reverse justify-center mb-6" id="starRatingContainer">
      <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 4.218 4.661.679c1.181.172 1.655 1.616.799 2.48l-3.374 3.29.8 4.643c.204 1.176-.99 2.079-2.051 1.516L12 18.897l-4.17 2.193c-1.06.562-2.255-.34-2.051-1.516l.8-4.643-3.374-3.29c-.856-.865-.382-2.308.799-2.48l4.661-.679L10.788 3.21Z" clip-rule="evenodd" /></svg></label>
      <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 4.218 4.661.679c1.181.172 1.655 1.616.799 2.48l-3.374 3.29.8 4.643c.204 1.176-.99 2.079-2.051 1.516L12 18.897l-4.17 2.193c-1.06.562-2.255-.34-2.051-1.516l.8-4.643-3.374-3.29c-.856-.865-.382-2.308.799-2.48l4.661-.679L10.788 3.21Z" clip-rule="evenodd" /></svg></label>
      <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 4.218 4.661.679c1.181.172 1.655 1.616.799 2.48l-3.374 3.29.8 4.643c.204 1.176-.99 2.079-2.051 1.516L12 18.897l-4.17 2.193c-1.06.562-2.255-.34-2.051-1.516l.8-4.643-3.374-3.29c-.856-.865-.382-2.308.799-2.48l4.661-.679L10.788 3.21Z" clip-rule="evenodd" /></svg></label>
      <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 4.218 4.661.679c1.181.172 1.655 1.616.799 2.48l-3.374 3.29.8 4.643c.204 1.176-.99 2.079-2.051 1.516L12 18.897l-4.17 2.193c-1.06.562-2.255-.34-2.051-1.516l.8-4.643-3.374-3.29c-.856-.865-.382-2.308.799-2.48l4.661-.679L10.788 3.21Z" clip-rule="evenodd" /></svg></label>
      <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 4.218 4.661.679c1.181.172 1.655 1.616.799 2.48l-3.374 3.29.8 4.643c.204 1.176-.99 2.079-2.051 1.516L12 18.897l-4.17 2.193c-1.06.562-2.255-.34-2.051-1.516l.8-4.643-3.374-3.29c-.856-.865-.382-2.308.799-2.48l4.661-.679L10.788 3.21Z" clip-rule="evenodd" /></svg></label>
    </div>

    <form id="ratingForm">{% csrf_token %}</form>

    <div class="flex justify-end">
      <button id="submitRatingButton" class="bg-blue-600 text-white px-5 py-2 rounded-md font-medium hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
        Submit Rating
      </button>
    </div>
  </div>
</div>

<div id="toastStack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ratingModal = document.getElementById('ratingModal');
  const rateButton = document.getElementById('rateButton');
  const closeModalButton = document.getElementById('closeModalButton');
  const starRatingContainer = document.getElementById('starRatingContainer');
  const submitRatingButton = document.getElementById('submitRatingButton');
  const toastStack = document.getElementById('toastStack');
  let selectedRating = 0;

  function showToast(message, type='success', timeout=1800){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='error' ? ' error' : '');
    el.textContent = message;
    toastStack.appendChild(el);
    setTimeout(() => {
      el.style.animation = 'toast-out .18s ease-in forwards';
      setTimeout(() => el.remove(), 200);
    }, timeout);
  }

  function openModal() {
    if (ratingModal) ratingModal.classList.remove('hidden');
  }

  function closeModal() {
    if (ratingModal) ratingModal.classList.add('hidden');
    const checkedRadio = starRatingContainer.querySelector('input[type="radio"]:checked');
    if (checkedRadio) checkedRadio.checked = false;
    selectedRating = 0;
    submitRatingButton.disabled = true;
  }

  function handleStarSelection(event) {
    if (event.target.name === 'rating') {
      selectedRating = parseInt(event.target.value, 10);
      submitRatingButton.disabled = false;
    }
  }

  async function handleSubmitRating() {
    if (selectedRating > 0) {
      const highlightId = '{{ highlight_id }}';
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      try {
        const response = await fetch("{% url 'komen_like_rate:submit_rating' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: new URLSearchParams({
            highlight_id: highlightId,
            rating: selectedRating
          })
        });

        const data = await response.json();

        if (data.status === 'success') {
          closeModal();
          showToast('✅ Rating berhasil dikirim!');
        } else {
          showToast('❌ Gagal kirim rating!', 'error');
        }
      } catch (err) {
        closeModal();
        showToast('⚠️ Terjadi error!', 'error');
      }
    }
  }

  if (rateButton) rateButton.addEventListener('click', openModal);
  if (closeModalButton) closeModalButton.addEventListener('click', closeModal);
  if (ratingModal) {
    ratingModal.addEventListener('click', (event) => {
      if (event.target === ratingModal) closeModal();
    });
  }
  if (starRatingContainer) starRatingContainer.addEventListener('change', handleStarSelection);
  if (submitRatingButton) submitRatingButton.addEventListener('click', handleSubmitRating);
});
</script>
