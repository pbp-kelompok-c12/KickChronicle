<div class="p-6 border border-zinc-700 bg-zinc-900 rounded-2xl">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold text-zinc-100">Comments</h2>

    <!-- badge jumlah -->
    <span class="inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full border border-zinc-700 bg-zinc-800 text-zinc-300">
      <span id="commentCount">{{ highlight.comments.count }}</span> Comments
    </span>
  </div>

  <!-- Form Komentar -->
  <form id="commentForm" class="mb-5">
    {% csrf_token %}
    <div class="flex items-start gap-3">
      <div class="flex-1">
        <textarea
          name="content"
          id="commentContent"
          rows="3"
          class="w-full px-4 py-3 border border-zinc-700 rounded-xl
                bg-zinc-800 text-zinc-100 placeholder-zinc-400
                focus:outline-none focus:ring-4 focus:ring-indigo-500/20 focus:border-indigo-500 transition"
          placeholder="Write a comment relevant to this highlight..."></textarea>
      </div>

      <button id="sendBtn" type="submit" class="h-11 px-5 rounded-xl font-semibold bg-indigo-600 text-white hover:bg-indigo-500 active:bg-indigo-700 border border-indigo-500/20 shadow-sm transition">
        <span class="inline-flex items-center gap-2">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
          Send
        </span>
      </button>
    </div>
    <p class="sr-only">Gunakan Ctrl/⌘ + Enter untuk mengirim.</p>
  </form>

  <!-- Daftar Komentar -->
  <div id="commentList" class="space-y-4">
    {% for comment in highlight.comments.all %}
      <div id="c-{{ comment.id }}" class="p-4 bg-zinc-900 border border-zinc-700 rounded-xl">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            {% if comment.user.profile and comment.user.profile.image %}
              <img class="w-10 h-10 rounded-full object-cover"
                  src="{{ comment.user.profile.image.url }}"
                  alt="{{ comment.user.username }}">
            {% else %}
              <div class="w-10 h-10 rounded-full bg-zinc-700 flex items-center justify-center text-zinc-200 font-semibold">
                {{ comment.user.username|slice:":1"|upper }}
              </div>
            {% endif %}
            <div>
              <p class="text-sm text-zinc-100 font-semibold">{{ comment.user.username }}</p>
              <p class="text-xs text-zinc-400">{{ comment.created_at|timesince }} lalu</p>
            </div>
          </div>
          {% if comment.user_id == request.user.id %}
          <button type="button"
            class="delete-comment text-rose-400 text-sm font-semibold hover:text-rose-300"
            data-id="{{ comment.id }}">
            Delete
          </button>
          {% endif %}
        </div>

        <p class="mt-3 text-zinc-100 leading-relaxed">{{ comment.content }}</p>
      </div>
    {% empty %}
      <p id="emptyState" class="text-zinc-400">Belum ada komentar.</p>
    {% endfor %}
  </div>
  </div>

  <!-- MODAL NOTIFIKASI -->
  <div id="modalAlert" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">
    <h3 id="modalTitle" class="text-lg font-semibold text-zinc-100 mb-2">Pemberitahuan</h3>
    <p id="modalMessage" class="text-zinc-300 mb-5">Pesan notifikasi di sini.</p>
    <button id="modalClose" class="px-5 py-2 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-500">
      Oke
    </button>
  </div>
  </div>

  <!-- MODAL KONFIRMASI HAPUS -->
  <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">
    <h3 class="text-lg font-semibold text-zinc-100 mb-3">Confirmation</h3>
    <p id="confirmMessage" class="text-zinc-300 mb-5">Are you sure you want to delete this comment?</p>
    <div class="flex justify-center gap-3">
      <button id="cancelDelete" class="px-5 py-2 bg-zinc-800 text-zinc-100 border border-zinc-700 rounded-xl font-semibold hover:bg-zinc-700 transition">
        Cancel
      </button>
      <button id="confirmDelete" class="px-5 py-2 bg-rose-600 text-white rounded-xl font-semibold hover:bg-rose-500 transition">
        Delete
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('commentForm');
  const textarea = document.getElementById('commentContent');
  const list = document.getElementById('commentList');
  const countEl = document.getElementById('commentCount');
  const sendBtn = document.getElementById('sendBtn');
  const getCsrf = () => document.querySelector('[name=csrfmiddlewaretoken]').value;

  // ✅ modal notifikasi
  const modal = document.getElementById('modalAlert');
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  const modalClose = document.getElementById('modalClose');
  function showModal(title, message) {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  modalClose.addEventListener('click', () => {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  });

  // ✅ modal konfirmasi hapus
  const confirmModal = document.getElementById('confirmModal');
  const confirmDelete = document.getElementById('confirmDelete');
  const cancelDelete = document.getElementById('cancelDelete');
  let pendingDelete = null;

  cancelDelete.addEventListener('click', () => {
    confirmModal.classList.add('hidden');
    confirmModal.classList.remove('flex');
    pendingDelete = null;
  });

  function autosize() {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  }
  textarea.addEventListener('input', autosize);
  autosize();

  textarea.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      form.requestSubmit();
    }
  });

  function updateEmptyState() {
    const items = list.querySelectorAll('[id^="c-"]');
    const empty = document.getElementById('emptyState');
    if (items.length === 0) {
      if (!empty) {
        const p = document.createElement('p');
        p.id = 'emptyState';
        p.className = 'text-gray-500';
        p.textContent = 'Belum ada komentar.';
        list.appendChild(p);
      }
    } else {
      empty?.remove();
    }
  }

  // Kirim komentar
  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const content = textarea.value.trim();
    if (!content) return;

    try {
      sendBtn.disabled = true;
      sendBtn.classList.add('opacity-60', 'cursor-not-allowed');

      const res = await fetch("{% url 'komen_like_rate:add_comment' highlight.id %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCsrf()
        },
        body: new URLSearchParams({ content })
      });

      const data = await res.json();
      if (data.error) {
        showModal('Gagal', 'Komentar gagal dikirim.');
        return;
      }

      const avatarHtml = data.avatar_url
        ? `<img class="w-10 h-10 rounded-full object-cover"
                src="${data.avatar_url}"
                alt="${data.user}">`
        : `<div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 font-semibold">
            ${data.initial}
          </div>`;

      const wrap = document.createElement('div');
      wrap.id = 'c-' + (data.id || ('new-' + Date.now()));
      wrap.className = 'p-4 bg-white border border-gray-200 rounded-xl';
      wrap.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            ${avatarHtml}
            <div>
              <p class="text-sm text-gray-900 font-semibold">${data.user}</p>
              <p class="text-xs text-gray-500">baru saja</p>
            </div>
          </div>
          <button type="button" class="delete-comment text-red-600 text-sm font-semibold hover:underline"
                  data-id="${data.id || ''}">
            Hapus
          </button>
        </div>
        <p class="mt-3 text-gray-900 leading-relaxed">${data.content}</p>
      `;
      wrap.querySelector('.comment-text').textContent = data.content;
      list.prepend(wrap);

      textarea.value = '';
      autosize();
      countEl.textContent = String(parseInt(countEl.textContent || '0', 10) + 1);
      updateEmptyState();
    } catch (err) {
      showModal('Kesalahan', 'Terjadi kesalahan.');
    } finally {
      sendBtn.disabled = false;
      sendBtn.classList.remove('opacity-60', 'cursor-not-allowed');
    }
  });

  // Hapus komentar pakai modal konfirmasi
  list.addEventListener('click', async (e) => {
    const btn = e.target.closest('.delete-comment');
    if (!btn) return;

    const id = btn.dataset.id;
    pendingDelete = { id, btn };
    confirmModal.classList.remove('hidden');
    confirmModal.classList.add('flex');
  });

  confirmDelete.addEventListener('click', async () => {
    if (!pendingDelete) return;
    const { id, btn } = pendingDelete;
    confirmModal.classList.add('hidden');
    confirmModal.classList.remove('flex');

    if (!id) {
      btn.closest('[id^="c-"]')?.remove();
      countEl.textContent = String(Math.max(0, parseInt(countEl.textContent || '1', 10) - 1));
      updateEmptyState();
      pendingDelete = null;
      return;
    }

    try {
      const res = await fetch("{% url 'komen_like_rate:delete_comment' 0 %}".replace('0', id), {
        method: 'POST',
        headers: { 'X-CSRFToken': getCsrf() }
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.status === 'ok') {
        document.getElementById('c-' + id)?.remove();
        countEl.textContent = String(Math.max(0, parseInt(countEl.textContent || '1', 10) - 1));
        updateEmptyState();
      } else {
        showModal('Gagal', 'Gagal menghapus komentar.');
      }
    } catch (err) {
      showModal('Kesalahan', 'Terjadi kesalahan saat menghapus.');
    } finally {
      pendingDelete = null;
    }
  });

  updateEmptyState();
});
</script>
